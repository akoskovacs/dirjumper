#!/bin/bash

# ------------------------------------------------------------------
# Copyleft (C) Ákos Kovács - 2016
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
# ------------------------------------------------------------------

SH_RC_FILE=".bashrc"
DJEXE="dj"
JMP_FN="j"
DJFILE="dj.list"

DJDIR=".dirjumper"

DJPATH="$HOME/$DJDIR"
DJLIST="$DJPATH/$DJFILE"
DJBIN="$DJPATH/bin"

USAGE="Usage: $DJEXE -ardgihv args"
VERSION="0.1.0"

list_aliases () {
  cat $DJLIST
}

get_alias () {
  egrep "\b$1\b" $DJLIST | rev | cut -d " " -f1 | rev
}

add_alias () {
  DIRNAME=$2
  if [[ $DIRNAME == "" ]]; then
      echo "No directory is given, using the current one '$(pwd)'."
      DIRNAME=$(pwd)
  fi
  ODNAME=$(get_alias $1)
  if [[ $ODNAME == "" ]]; then
    echo "$1 $DIRNAME" >> $DJLIST
    exit 0;
  else
    echo "Alias '$1' is already exist for path '$ODNAME'!"
    echo "Use '$(basename $0) -r $1 <new-alias>' to rename it."
    exit 1;
  fi
}

rename_alias () {
  if [[ $2 == "" ]]; then
    echo "You must give the alias a new name!"
    exit 1;
  fi
  sed -i "s/\b$1\b/$2/" $DJLIST
}

delete_alias () {
  sed -i "/\b$1\b/d" $DJLIST
}

install_dirjumper () {
  DJ=$(cd $(dirname $0) ; pwd -P)
  echo "Creating '$DJLIST'..."
  touch $DJLIST
  echo "Appending dirjump to '$SH_RC_FILE'..."
  echo -e "\n# Generated by '$0'." >> $HOME/$SH_RC_FILE
  echo "PATH=\"\$PATH:$DJBIN\"" >> $HOME/$SH_RC_FILE
  echo -e "$JMP_FN () {\n\tif [[ \$1 == \"\" ]]; then\n\t\t$0 -l\n\telse" >> $HOME/$SH_RC_FILE
  echo -e "\t\tcd \$($0 -g \$1)\n\tfi\n}\n" >> $HOME/$SH_RC_FILE
  echo "All done."
  echo
  echo "Now you can use 'ad -a <alias>' to add an alias for this directory."
  echo "And then use 'j <alias>' to return here."
}

print_help () {
  echo $USAGE
  echo
  echo -e "\t-a <ALIAS> <DIR>\t\tAdd an alias, use the working dir. if <DIR> is not set"
  echo -e "\t-r <OLD-ALIAS> <NEW-ALIAS>\tRename a directory alias"
  echo -e "\t-d <ALIAS>\t\t\tDelete a directory alias"
  echo -e "\t-g <ALIAS>\t\t\tGet the full path for an alias"
  echo -e "\t-l\t\t\t\tList all aliases"
  echo -e "\t-h\t\t\t\tThis help message"
  echo -e "\t-v\t\t\t\tThe version of the script"
  echo
  echo "To jump, use '$JMP_FN <alias>'."
}

while getopts "a:g:r:d:livh" optname
  do
    case "$optname" in
      "v")
        echo "Version $VERSION"
        exit 0;
        ;;
      "a")
        add_alias $OPTARG ${@:$OPTIND:1}
        ;;
      "r")
        rename_alias $OPTARG ${@:$OPTIND:1}
        ;;
      "d")
        delete_alias $OPTARG
        ;;
      "i")
        install_dirjumper
        ;;
      "l")
        list_aliases
        exit 0;
        ;;
      "g")
        get_alias $OPTARG
        exit 0;
        ;;
      "h")
        print_help
        exit 0;
        ;;
      "?")
        echo "Unknown option $OPTARG"
        exit 0;
        ;;
      ":")
        echo "No argument value for option $OPTARG"
        exit 0;
        ;;
      *)
        echo "Unknown error while processing options"
        exit 0;
        ;;
    esac
  done

shift $(($OPTIND - 1))

if [ ! -e $DJLIST ]; then
  echo "Installing..."
  mkdir -p $DJBIN
  cp $DJEXE $DJBIN/$DJEXE
  chmod +x $DJBIN/$DJEXE
  $DJBIN/$DJEXE -i
  rm $DJEXE
  echo "After creating a new bash instance you can use all commands."
else
  if [[ $# == 0 ]]; then
    print_help
    exit 1;
  fi
fi
