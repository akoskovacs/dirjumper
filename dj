#!/bin/bash

# ------------------------------------------------------------------
# Copyleft (C) Ákos Kovács - 2017
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
# ------------------------------------------------------------------

## Stable, main update server
REPO="https://raw.githubusercontent.com/akoskovacs/dirjumper/master"

## Uncomment for upstream updates
#REPO="https://raw.githubusercontent.com/akoskovacs/dirjumper/upstream"

## Uncomment for local debugging
#REPO="http://localhost:8000"


SH_RC_FILE=".bashrc"
DJEXE="dj"
JMP_FN="j"
DJFILE="dj.list"

DJDIR=".dirjumper"

DJPATH="$HOME/$DJDIR"
DJLIST="$DJPATH/$DJFILE"
DJBIN="$DJPATH/bin"

USAGE="Usage: $DJEXE -ardgihv args"
VERSION="0.2.0"

COLOR_RED="\x1b[31m"
COLOR_BLUE="\x1b[34m"
COLOR_BBLUE="\x1b[1;34m"
COLOR_PURPLE="\x1b[35m"
COLOR_BPURPLE="\x1b[1;35m"
COLOR_GREEN="\x1b[32m"
COLOR_BGREEN="\x1b[1;32m"
COLOR_YELLOW="\x1b[33m"
COLOR_END="\x1b[0m"

list_aliases () {
    # cat $DJLIST
    local wd=`pwd`
    while read line; do
        local al=`echo $line | cut -d " " -f1`
        local pth=`echo $line | cut -d " " -f2`
        local pth_color=$COLOR_BBLUE
        local pth_sel=" "
        if [[ $pth = $wd ]]; then
            pth_color=$COLOR_BGREEN
            pth_sel="+" 
        fi;
        printf "$pth_color\t$pth_sel %s$END_COLOR\t$COLOR_PURPLE%s$END_COLOR\n" $al $pth
    done < $DJLIST;
}

read_alias () {
  egrep "\b$1\b" $DJLIST | rev | cut -d " " -f1 | rev
}

get_alias () {
  local al=`read_alias $1`
  if [[ $al = "" ]]; then
    echo -e "${COLOR_RED}Alias '$1' not found! $COLOR_END" >&2
    echo "."
  else
    echo $al
  fi;
}

add_alias () {
  DIRNAME=$2
  if [[ $DIRNAME = "" ]]; then
      echo -en $COLOR_YELLOW
      echo "No directory is given, using the current one '$(pwd)'."
      echo -en $COLOR_END
      DIRNAME=$(pwd)
  fi
  DIRNAME=`realpath $DIRNAME`
  ODNAME=`read_alias $1`
  if [[ $ODNAME = "" ]]; then
    echo "$1 $DIRNAME" >> $DJLIST
    exit 0;
  else
    echo -en $COLOR_RED
    echo "Alias '$1' is already exist for path '$ODNAME'!"
    echo -en $COLOR_END
    echo "Use '$(basename $0) -r $1 <new-alias>' to rename it."
    exit 1;
  fi;
}

rename_alias () {
  if [[ $2 = "" ]]; then
    echo -en $COLOR_RED
    echo "You must give the alias a new name!"
    echo -en $COLOR_END
    exit 1;
  fi;
  get_alias $1 >> /dev/null
  sed -i "s/\b$1\b/$2/" $DJLIST
}

delete_alias () {
  get_alias $1 >> /dev/null
  sed -i "/\b$1\b/d" $DJLIST
}

init_sh () {
  echo -e "alias dj=$0"
  echo -e "$JMP_FN () {\n\tif [[ \$1 = \"\" ]]; then\n\t\t$0 -l\n\telse"
  echo -e "\t\tcd \$($0 -g \$1)\n\tfi;\n}\n"
}

install_dirjumper () {
  DJ=$(cd $(dirname $0) ; pwd -P)
  echo "Creating '$DJLIST'..."
  touch $DJLIST
  echo "Appending dirjump to '$SH_RC_FILE'..."
  echo -e "\n# Initialize directory jumper. Generated by '$0'." >> $HOME/$SH_RC_FILE
  echo -e "eval \"\$($0 -s)\"\n" >> $HOME/$SH_RC_FILE
  echo -e $COLOR_GREEN
  echo "All done. Start a new shell to apply changes."
  echo -e $COLOR_END
  echo "Now you can use '$DJEXE -a <alias>' to add an alias for this directory."
  echo "And then use 'j <alias>' to return here."
}

update_dirjumper () {
  echo -e "${COLOR_YELLOW}Checking for new version (current is v$VERSION)...${COLOR_END}"

  cd $DJBIN
  new_version=$(wget "$REPO/VERSION" -O- -o /tmp/dj.log)
  if [ $? -ne 0 ]; then 
      cat /tmp/dj.log
      echo -e "${COLOR_RED}Error while downloading version information!${COLOR_END}"
      exit 1
  fi;
  if [ $VERSION = $new_version ]; then
      echo -e "${COLOR_GREEN}Your version is up-to-date (v$VERSION).${COLOR_END}"
      exit 0
  fi;
  echo -ne "${COLOR_YELLOW}New version (v$new_version) found. Do you want to upgrade? [y/N]: ${COLOR_END}"
  read answ
  if [ $answ = "y" -o $answ = "Y" ]; then
    mv dj dj.old
    wget "$REPO/dj" -o/tmp/dj.log
    if [ $? -ne 0 ]; then
      cat /tmp/dj.log
      echo -e "${COLOR_RED}Error while downloading upgrades!${COLOR_END}"
      exit 1
    fi;
    chmod +x dj
    echo -e "${COLOR_GREEN}Upgrade done...${COLOR_END}"
    rm /tmp/dj.log
  else
      echo -e "${COLOR_RED}Upgrade aborted.${COLOR_END}"
      exit 1
  fi;
  exit 0
}

downgrade_dirjumper () {
  cd $DJBIN
  if [ -e dj.old ]; then
    old_version=$(./dj.old -v)
    mv dj dj.older
    mv dj.old dj
    mv dj.older dj.old
    echo -e "${COLOR_GREEN}Sucessfully downgraded from '${old_version}' to '${VERSION}'.${COLOR_END}"
    exit 0
  else
    echo -e "${COLOR_RED}No older version found!${COLOR_END}"
    exit 1
  fi;
}

print_help () {
  echo $USAGE
  echo -e "\t-a <ALIAS> <DIR>\t\tAdd an alias, use the working dir. if <DIR> is not set"
  echo -e "\t-r <OLD-ALIAS> <NEW-ALIAS>\tRename a directory alias"
  echo -e "\t-d <ALIAS>\t\t\tDelete a directory alias"
  echo -e "\t-g <ALIAS>\t\t\tGet the full path for an alias"
  echo -e "\t-l\t\t\t\tList all aliases\n"
  echo -e "\t-u\t\t\t\tUpgrade the script to the latest version"
  echo -e "\t-w\t\t\t\tDowngrade the script to an older version\n"
  echo -e "\t-h\t\t\t\tThis help message"
  echo -e "\t-v\t\t\t\tThe version of the script"
  echo
  echo "To jump, use '$JMP_FN <alias>'."
}

while getopts "a:g:r:d:liuwsvh" optname
  do
    case "$optname" in
      "v")
        echo $VERSION
        exit 0;
        ;;
      "a")
        add_alias $OPTARG ${@:$OPTIND:1}
        ;;
      "r")
        rename_alias $OPTARG ${@:$OPTIND:1}
        ;;
      "d")
        delete_alias $OPTARG
        exit 0;
        ;;
      "i")
        install_dirjumper
        ;;
      "s")
        init_sh
        exit 0;
        ;;
      "l")
        list_aliases
        exit 0;
        ;;
      "u")
        update_dirjumper
        ;;
      "w")
        downgrade_dirjumper
        ;;
      "g")
        get_alias $OPTARG
        exit 0;
        ;;
      "h")
        print_help
        exit 0;
        ;;
      "?")
        echo -e "${COLOR_RED}Unknown option $OPTARG${COLOR_END}"
        exit 0;
        ;;
      ":")
        echo -e "${COLOR_RED}No argument value for option $OPTARG${COLOR_END}"
        exit 0;
        ;;
      *)
        echo -e "${COLOR_RED}Unknown error while processing options${COLOR_RED}"
        exit 0;
        ;;
    esac
  done

shift $(($OPTIND - 1))

if [ ! -e $DJLIST ]; then
  echo "Installing..."
  mkdir -p $DJBIN
  cp $DJEXE $DJBIN/$DJEXE
  chmod +x $DJBIN/$DJEXE
  $DJBIN/$DJEXE -i
  rm $DJEXE
else
  if [[ $# == 0 ]]; then
    print_help
    exit 1;
  fi
fi
